{% extends "base.html" %}

{% block head_extra %}
  {% if status in ['queued', 'processing'] %}
    <script>
      // Poll for updates every 2 seconds for active jobs
      let pollInterval = setInterval(function() {
        fetch('/jobs/{{ job_id }}?format=json')
          .then(response => {
            if (!response.ok) {
              throw new Error('HTTP ' + response.status);
            }
            return response.json();
          })
          .then(data => {
            // Update progress
            document.getElementById('progress-value').textContent = data.progress + '%';
            document.getElementById('progress-bar').style.width = data.progress + '%';
            document.getElementById('progress-bar').textContent = data.progress + '%';
            
            // Update message
            document.getElementById('status-message').textContent = data.message || '';
            
            // Update detail if available
            if (data.detail) {
              const detailEl = document.getElementById('status-detail');
              if (detailEl) {
                detailEl.textContent = data.detail;
                detailEl.style.display = 'block';
              }
            }
            
            // Update FFmpeg stats
            if (data.ffmpeg_stats) {
              const statsContainer = document.getElementById('ffmpeg-stats-container');
              if (statsContainer) {
                statsContainer.style.display = 'block';
                
                const stats = data.ffmpeg_stats;
                if (stats.fps) {
                  document.getElementById('stat-fps').textContent = stats.fps;
                  document.getElementById('stat-fps-box').style.display = 'block';
                }
                if (stats.speed) {
                  document.getElementById('stat-speed').textContent = stats.speed + 'x';
                  document.getElementById('stat-speed-box').style.display = 'block';
                }
                if (stats.frame) {
                  document.getElementById('stat-frame').textContent = stats.frame;
                  document.getElementById('stat-frame-box').style.display = 'block';
                }
                if (stats.bitrate) {
                  document.getElementById('stat-bitrate').textContent = stats.bitrate;
                  document.getElementById('stat-bitrate-box').style.display = 'block';
                }
                if (stats.size) {
                  document.getElementById('stat-size').textContent = stats.size;
                  document.getElementById('stat-size-box').style.display = 'block';
                }
                if (stats.time) {
                  document.getElementById('stat-time').textContent = stats.time + 's';
                  document.getElementById('stat-time-box').style.display = 'block';
                }
              }
            }
            
            // Update ETA
            if (data.eta_seconds !== undefined && data.eta_seconds > 0) {
              const minutes = Math.floor(data.eta_seconds / 60);
              const seconds = Math.floor(data.eta_seconds % 60);
              document.getElementById('eta-display').textContent = minutes + 'm ' + seconds + 's';
              document.getElementById('eta-row').style.display = 'block';
            } else {
              document.getElementById('eta-row').style.display = 'none';
            }
            
            // Update elapsed time
            if (data.elapsed_seconds !== undefined) {
              const minutes = Math.floor(data.elapsed_seconds / 60);
              const seconds = Math.floor(data.elapsed_seconds % 60);
              document.getElementById('elapsed-display').textContent = minutes + 'm ' + seconds + 's';
            }
            
            // Update status badge
            const statusBadge = document.getElementById('status-badge');
            statusBadge.textContent = data.status;
            statusBadge.className = 'status ' + {
              'finished': 'success',
              'failed': 'error',
              'killed': 'error',
              'processing': 'warning',
              'queued': 'info'
            }[data.status];

            // If job finished, failed, or killed, stop polling and reload page
            if (data.status === 'finished' || data.status === 'failed' || data.status === 'killed') {
              clearInterval(pollInterval);
              setTimeout(() => window.location.reload(), 500);
            }
          })
          .catch(err => {
            console.warn('Poll failed (will retry):', err.message);
          });
      }, 2000);

      async function killJob() {
        if (!confirm('Are you sure you want to kill this job? This action cannot be undone.')) {
          return;
        }

        const button = document.getElementById('kill-job-btn');
        button.disabled = true;
        button.textContent = 'Killing...';

        try {
          const response = await fetch('/jobs/{{ job_id }}/kill', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            }
          });

          if (response.ok) {
            clearInterval(pollInterval);
            button.textContent = 'Killed';
            const statusBadge = document.getElementById('status-badge');
            statusBadge.textContent = 'killed';
            statusBadge.className = 'status error';
            setTimeout(() => window.location.reload(), 1000);
          } else {
            const data = await response.json();
            alert('Failed to kill job: ' + (data.detail || 'Unknown error'));
            button.disabled = false;
            button.textContent = 'Kill Job';
          }
        } catch (error) {
          alert('Error killing job: ' + error.message);
          button.disabled = false;
          button.textContent = 'Kill Job';
        }
      }
    </script>
  {% endif %}
  <style>
    .job-header {
      background: #f8fafc;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 24px;
    }
    .job-header-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 12px;
    }
    .job-header-top h1 {
      margin: 0;
    }
    .job-header-meta {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .job-id {
      font-family: monospace;
      font-size: 18px;
      color: #1f2937;
      margin: 0;
    }
    .status {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 4px;
      font-weight: 600;
      text-transform: capitalize;
    }
    .status.success {
      background: #e8f5e9;
      color: #256029;
    }
    .status.error {
      background: #fdecea;
      color: #b3261e;
    }
    .status.warning {
      background: #fff3cd;
      color: #856404;
    }
    .status.info {
      background: #e0f2fe;
      color: #1f7a34;
    }
    .kill-btn {
      padding: 10px 20px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
    }
    .kill-btn:hover {
      background: #c82333;
    }
    .kill-btn:disabled {
      background: #6c757d;
      cursor: not-allowed;
      opacity: 0.6;
    }
    .progress-section {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 24px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    .progress-bar-container {
      background: #e2e8f0;
      border-radius: 8px;
      height: 32px;
      overflow: hidden;
      margin: 16px 0;
    }
    .progress-bar {
      background: linear-gradient(90deg, #28a745, #20c997);
      height: 100%;
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      min-width: 32px;
    }
    .status-detail {
      font-family: 'Courier New', monospace;
      font-size: 12px;
      color: #6b7280;
      background: #f9fafb;
      padding: 8px 12px;
      border-radius: 4px;
      margin-top: 8px;
      display: {{ 'block' if detail else 'none' }};
    }
    .ffmpeg-stats {
      background: #fff;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 24px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      display: {{ 'block' if ffmpeg_stats else 'none' }};
    }
    .ffmpeg-stats h3 {
      margin: 0 0 12px 0;
      font-size: 16px;
      color: #1f2937;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
      gap: 12px;
    }
    .stat-box {
      background: #f8fafc;
      padding: 12px;
      border-radius: 6px;
      text-align: center;
      border: 1px solid #e5e7eb;
      display: none;
    }
    .stat-label {
      display: block;
      font-size: 11px;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
      font-weight: 600;
    }
    .stat-value {
      display: block;
      font-size: 20px;
      font-weight: 700;
      color: #1f2937;
      font-family: 'Courier New', monospace;
    }
    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    .info-box {
      background: #f8fafc;
      padding: 12px;
      border-radius: 6px;
    }
    .info-box strong {
      display: block;
      color: #6b7280;
      font-size: 12px;
      margin-bottom: 4px;
    }
    .result-box,
    .error-box {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 24px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    .result-box h3,
    .error-box h3 {
      margin-top: 0;
    }
    .download-link {
      display: inline-block;
      padding: 10px 20px;
      background: #28a745;
      color: white;
      text-decoration: none;
      border-radius: 6px;
      font-weight: 600;
    }
    .download-link:hover {
      background: #1f7a34;
    }
    .error-box {
      background: #fdecea;
      border-left: 4px solid #b3261e;
    }
    .error-box pre {
      background: #fff;
      padding: 12px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 12px;
    }
    table.history-table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      margin-top: 16px;
    }
    table.history-table th,
    table.history-table td {
      padding: 10px 12px;
      border-bottom: 1px solid #e2e8f0;
      font-size: 14px;
      text-align: left;
    }
    table.history-table th {
      background: #f8fafc;
      color: #1f2937;
      font-weight: 600;
    }
    .back-link {
      display: inline-block;
      margin-bottom: 20px;
      color: #28a745;
      text-decoration: none;
      font-weight: 600;
    }
    .back-link:hover {
      text-decoration: underline;
    }
  </style>
{% endblock %}

{% block content %}
  <a href="/jobs" class="back-link">&larr; Back to Jobs</a>

  <div class="job-header">
    <div class="job-header-top">
      <div class="job-header-meta">
        <h1>Job Details</h1>
        <p class="job-id">{{ job_id }}</p>
      </div>
      {% if status in ['queued', 'processing'] %}
        <button id="kill-job-btn" class="kill-btn" onclick="killJob()">Kill Job</button>
      {% endif %}
    </div>
    <span class="status {{ 'success' if status == 'finished' else 'error' if status == 'failed' else 'warning' if status == 'processing' else 'info' }}" id="status-badge">{{ status }}</span>

    {% if status in ['queued', 'processing'] %}
      <div style="margin-top: 16px;">
        <button id="kill-job-btn" class="kill-btn" onclick="killJob()">Kill Job</button>
      </div>
    {% endif %}
  </div>

  <div class="progress-section">
    <h2>Progress: <span id="progress-value">{{ progress }}%</span></h2>
    <div class="progress-bar-container">
      <div class="progress-bar" id="progress-bar" style="width: {{ progress }}%">
        {{ progress }}%
      </div>
    </div>
    <p><strong>Current status:</strong> <span id="status-message">{{ message }}</span></p>
    <div class="status-detail" id="status-detail">{{ detail or '' }}</div>
    {% if eta_seconds is not none and status == 'processing' %}
      <p id="eta-row"><strong>Estimated time remaining:</strong> <span id="eta-display">{{ (eta_seconds // 60)|int }}m {{ (eta_seconds % 60)|int }}s</span></p>
    {% else %}
      <p id="eta-row" style="display: none;"><strong>Estimated time remaining:</strong> <span id="eta-display"></span></p>
    {% endif %}
    {% if elapsed_seconds is not none %}
      <p><strong>Elapsed:</strong> <span id="elapsed-display">{{ (elapsed_seconds // 60)|int }}m {{ (elapsed_seconds % 60)|int }}s</span></p>
    {% elif duration_ms is not none %}
      <p><strong>Duration:</strong> {{ (duration_ms / 1000 // 60)|int }}m {{ (duration_ms / 1000 % 60)|int }}s</p>
    {% endif %}
  </div>

  <div class="ffmpeg-stats" id="ffmpeg-stats-container">
    <h3>FFmpeg Live Statistics</h3>
    <div class="stats-grid">
      <div class="stat-box" id="stat-fps-box" style="display: {{ 'block' if ffmpeg_stats and ffmpeg_stats.get('fps') else 'none' }}">
        <span class="stat-label">FPS</span>
        <span class="stat-value" id="stat-fps">{{ ffmpeg_stats.get('fps') if ffmpeg_stats and ffmpeg_stats.get('fps') else '—' }}</span>
      </div>
      <div class="stat-box" id="stat-speed-box" style="display: {{ 'block' if ffmpeg_stats and ffmpeg_stats.get('speed') else 'none' }}">
        <span class="stat-label">Speed</span>
        <span class="stat-value" id="stat-speed">{{ (ffmpeg_stats.get('speed') ~ 'x') if ffmpeg_stats and ffmpeg_stats.get('speed') else '—' }}</span>
      </div>
      <div class="stat-box" id="stat-frame-box" style="display: {{ 'block' if ffmpeg_stats and ffmpeg_stats.get('frame') else 'none' }}">
        <span class="stat-label">Frame</span>
        <span class="stat-value" id="stat-frame">{{ ffmpeg_stats.get('frame') if ffmpeg_stats and ffmpeg_stats.get('frame') else '—' }}</span>
      </div>
      <div class="stat-box" id="stat-time-box" style="display: {{ 'block' if ffmpeg_stats and ffmpeg_stats.get('time') else 'none' }}">
        <span class="stat-label">Time</span>
        <span class="stat-value" id="stat-time">{{ (ffmpeg_stats.get('time') ~ 's') if ffmpeg_stats and ffmpeg_stats.get('time') else '—' }}</span>
      </div>
      <div class="stat-box" id="stat-bitrate-box" style="display: {{ 'block' if ffmpeg_stats and ffmpeg_stats.get('bitrate') else 'none' }}">
        <span class="stat-label">Bitrate</span>
        <span class="stat-value" id="stat-bitrate">{{ ffmpeg_stats.get('bitrate') if ffmpeg_stats and ffmpeg_stats.get('bitrate') else '—' }}</span>
      </div>
      <div class="stat-box" id="stat-size-box" style="display: {{ 'block' if ffmpeg_stats and ffmpeg_stats.get('size') else 'none' }}">
        <span class="stat-label">Size</span>
        <span class="stat-value" id="stat-size">{{ ffmpeg_stats.get('size') if ffmpeg_stats and ffmpeg_stats.get('size') else '—' }}</span>
      </div>
    </div>
  </div>

  <div class="info-grid">
    <div class="info-box">
      <strong>Created</strong>
      {{ created }}
    </div>
    <div class="info-box">
      <strong>Started</strong>
      {{ started or 'Not started' }}
    </div>
  </div>

  {% if result %}
    <div class="result-box">
      <h3>Result</h3>
      {% if result.file_url %}
        <p><a href="{{ result.file_url }}" target="_blank" class="download-link">Download file</a></p>
        {% if result.path %}
          <p><strong>Path:</strong> <code>{{ result.path }}</code></p>
        {% endif %}
      {% elif result.outputs %}
        <ul>
          {% for name, url in result.outputs.items() %}
            <li><a href="{{ url }}" target="_blank">{{ name }}</a></li>
          {% endfor %}
        </ul>
      {% endif %}
    </div>
  {% endif %}

  {% if error %}
    <div class="error-box">
      <h3>Error</h3>
      <pre>{{ error }}</pre>
    </div>
  {% endif %}

  <h3>Progress History</h3>
  <table class="history-table">
    <thead>
      <tr>
        <th>Time</th>
        <th>Progress</th>
        <th>Message</th>
      </tr>
    </thead>
    <tbody>
      {% if history %}
        {% for item in history %}
          <tr>
            <td>{{ item.timestamp }}</td>
            <td>{{ item.progress }}%</td>
            <td>{{ item.message }}</td>
          </tr>
        {% endfor %}
      {% else %}
        <tr>
          <td colspan="3">No history yet</td>
        </tr>
      {% endif %}
    </tbody>
  </table>
{% endblock %}
